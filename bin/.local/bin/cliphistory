#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck disable=SC1090
source "${ROFI_COMMON:-$script_dir/rofi-common}"

main() {
  require_cmd cliphist
  require_cmd wl-copy
  rofi_init "${CLIPHIST_ROFI_BIN:-}"

  prompt="${1:-${CLIPHIST_PROMPT:-clipboard}}"
  # shellcheck disable=SC2206
  extra_args=( ${CLIPHIST_ROFI_ARGS:-} )

  rofi_cmd=(
    -dmenu
    -i
    -p "$prompt"
    -normal-window
    -matching fuzzy
    -sort
    -show-icons
    -width 40
    -lines 12
    -line-margin 4
    -line-padding 6
  )
  rofi_cmd+=( "${extra_args[@]}" )

  mapfile -t items < <(cliphist list 2>/dev/null || true)
  if (( ${#items[@]} == 0 )); then
    if has_cmd wl-paste; then
      if wl-paste --type text >/dev/null 2>&1; then
        wl-paste --type text 2>/dev/null | cliphist store >/dev/null 2>&1 || true
      elif wl-paste --type image >/dev/null 2>&1; then
        wl-paste --type image 2>/dev/null | cliphist store >/dev/null 2>&1 || true
      fi
    fi
    mapfile -t items < <(cliphist list 2>/dev/null || true)
  fi
  if (( ${#items[@]} == 0 )); then
    if has_cmd notify-send; then
      notify-send "Clipboard history" "No entries yet. Copy something to populate cliphist."
    fi
    exit 0
  fi

  selection=$(printf '%s\n' "${items[@]}" | rofi_run "${rofi_cmd[@]}")
  selection=${selection%$'\n'}
  [[ -n "$selection" ]] || exit 0

  entry_id=${selection%%$'\t'*}
  [[ -n "$entry_id" ]] || exit 0

  tmp_file=$(mktemp)
  trap 'rm -f "$tmp_file"' EXIT

  if ! cliphist decode "$entry_id" > "$tmp_file"; then
    if has_cmd notify-send; then
      notify-send "Clipboard history" "Failed to decode entry ${entry_id}."
    fi
    exit 1
  fi

  mime_type=""
  if has_cmd file; then
    mime_type=$(file -b --mime-type "$tmp_file" 2>/dev/null || true)
  fi

  if [[ -n "$mime_type" ]]; then
    if ! wl-copy --type "$mime_type" < "$tmp_file"; then
      if has_cmd notify-send; then
        notify-send "Clipboard history" "Failed to copy entry ${entry_id}."
      fi
      exit 1
    fi
  else
    if ! wl-copy < "$tmp_file"; then
      if has_cmd notify-send; then
        notify-send "Clipboard history" "Failed to copy entry ${entry_id}."
      fi
      exit 1
    fi
  fi

  if has_cmd notify-send; then
    notify-send "Clipboard history" "Copied selection back to clipboard"
  fi
}

main "$@"
