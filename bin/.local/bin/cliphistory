#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck disable=SC1090
source "${ROFI_COMMON:-$script_dir/rofi-common}"

main() {
  require_cmd cliphist
  require_cmd wl-copy
  rofi_init "${CLIPHIST_ROFI_BIN:-}"

  prompt="${1:-${CLIPHIST_PROMPT:-clipboard}}"
  # shellcheck disable=SC2206
  extra_args=( ${CLIPHIST_ROFI_ARGS:-} )

  rofi_cmd=(
    -dmenu
    -i
    -p "$prompt"
    -normal-window
    -matching fuzzy
    -sort
    -show-icons
    -width 40
    -lines 12
    -line-margin 4
    -line-padding 6
  )
  rofi_cmd+=( "${extra_args[@]}" )

  mapfile -t items < <(cliphist list)
  (( ${#items[@]} )) || exit 0

  selection=$(printf '%s\n' "${items[@]}" | rofi_run "${rofi_cmd[@]}")
  selection=${selection%$'\n'}
  [[ -n "$selection" ]] || exit 0

  entry_id=${selection%%$'\t'*}
  [[ -n "$entry_id" ]] || exit 0

  tmp_file=$(mktemp)
  trap 'rm -f "$tmp_file"' EXIT

  cliphist decode "$entry_id" > "$tmp_file"
  wl-copy < "$tmp_file"

  if has_cmd notify-send; then
    notify-send "Clipboard history" "Copied selection back to clipboard"
  fi
}

main "$@"
