#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck disable=SC1090
source "${ROFI_COMMON:-$script_dir/rofi-common}"

main() {
  require_cmd pass
  rofi_init "${PASSMENU_ROFI_BIN:-}"

  prompt="${1:-${PASSMENU_PROMPT:-pass}}"
  # Allow extra user-provided rofi arguments via PASSMENU_ROFI_ARGS.
  # shellcheck disable=SC2206 # Users provide space-separated args.
  extra_args=( ${PASSMENU_ROFI_ARGS:-} )

  rofi_cmd=(
    -dmenu
    -i
    -p "$prompt"
    -normal-window
    -matching fuzzy
    -sort
    -show-icons
    -width 40
    -lines 12
    -line-margin 4
    -line-padding 6
  )
  rofi_cmd+=( "${extra_args[@]}" )

  store_dir=${PASSWORD_STORE_DIR:-$HOME/.password-store}
  if [[ ! -d "$store_dir" ]]; then
    printf 'passmenu: password store not found at %s\n' "$store_dir" >&2
    exit 1
  fi

  # Build a sorted list of entries relative to $store_dir.
  mapfile -t items < <(
    cd "$store_dir" &&
    find . -type f -name '*.gpg' -printf '%P\n' |
    sed 's/\.gpg$//' |
    LC_ALL=C sort
  )

  (( ${#items[@]} )) || exit 0

  selection=$(printf '%s\n' "${items[@]}" | rofi_run "${rofi_cmd[@]}")
  selection=${selection%$'\n'}
  [[ -n "$selection" ]] || exit 0

  pass show -c "$selection" >/dev/null
}

main "$@"
